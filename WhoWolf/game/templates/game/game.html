{% extends 'game/base.html' %}

{% block content %}
    <h1>Game Round: <span id="round">{{ lobby.round }}</span> (Time left: <span id="time"></span>s)</h1>

    <p>It's <span id="daytime"></span></p>

    <p>Hi {{ player.username }}</p>
    <p>You are in the lobby {{ lobby.game_id }}</p>

    <p>{% if player.username == lobby.host.username %} You are the host {% endif %} </p>

    <p id="role"></p>

    <p>List of players</p>
    <ul id="players"></ul>

    {% if player.username == lobby.host.username and lobby.round == 0 %}
        <button id="start_button" onclick="start_game()" class="btn btn-primary">Start game</button>
    {% endif %}
{% endblock %}

{% block script %}
    <script>
        function get_players(players, data) {
            players_list = "";
            for (i = 0; i < players.length; i++) {
                var vote = ""
                if (players[i].alive) {
                    var player_status = "Alive"
                    if (data.round % 2 == 0) {
                        var vote_button = "<a href=\"#\" onclick=\"vote(" + players[i].id + ")\">Vote</a>"
                        var vote_count = data.players[i].vote_count

                        var vote = vote_button + " (Votes: " + vote_count + ")"
                    }
                } else {
                    var player_status = "Dead"
                }

                players_list += "<li>" + players[i].username + " (" + player_status + ") " + vote + "</li>";
                if (players[i].username == '{{ player.username }}') {
                    if (players[i].role) {
                        $("#role").html('Your role is ' + players[i].role);
                    }
                }
            }
            $("#players").html(players_list);
        }

        function status() {
            $.ajax({
                type: "GET",
                url: "{% url 'game:status' lobby.game_id %}",
                dataType: 'json',
            }).done(function(data) {
                $("#round").html(data.round);
                $("#time").html(data.time);
                get_players(data.players, data)

                if (data.round > 0) {
                    $("#start_button").remove();

                    if (data.round % 2 == 1) {
                        $("#daytime").html("nighttime");
                    } else if (data.round % 2 == 0) {
                        $("#daytime").html("daytime");
                    }
                }
            });
        }

        function start_game() {
            $("#start_button").addClass('disabled');

            $.ajax({
                type: "POST",
                url: "{% url 'game:start' lobby.game_id %}",
                dataType: "json",
                data: {"csrfmiddlewaretoken": "{{ csrf_token }}"}
            }).done(function(data) {
                $("#start_button").remove();
            });
        }

        function vote(user_id) {
            $.ajax({
                type: "POST",
                url: "{% url 'game:vote' lobby.game_id %}",
                dataType: "json",
                data: {
                    "csrfmiddlewaretoken": "{{ csrf_token }}",
                    "vote": user_id
                }
            }).done(function(data) {
                // do nothing
            });
        }

        status();
        setInterval(function(){status();}, 1000);
    </script>
{% endblock %}